{%- liquid
  assign variant = product.selected_or_first_available_variant

  if product.price_varies
    assign display_price = product.price_min | money
    assign price_prefix = "From "
  else
    assign display_price = product.price | money
    assign price_prefix = ""
  endif
-%}

<div class="best-products__product-card" data-product-id="{{ product.id }}">
  <div class="best-products__card-inner">

    {%- comment -%} Product Image {%- endcomment -%}
    <a href="{{ product.url }}" class="best-products__image-wrapper">
      {%- if product.featured_image -%}
        {%- render 'lazy-image',
            image: product.featured_image,
            sizes: '(max-width: 768px) 80vw, (max-width: 1024px) 40vw, 25vw',
            preload: false
        -%}
      {%- else -%}
        {{ 'product-1' | placeholder_svg_tag: 'best-products__placeholder' }}
      {%- endif -%}
    </a>

    {%- comment -%} Content Section {%- endcomment -%}
    <div class="best-products__content">

      {%- comment -%} Judge.me Reviews - Visual Star Display {%- endcomment -%}
      {%- assign rating = product.metafields.reviews.rating.value.rating | plus: 0 -%}
      {%- assign count = product.metafields.reviews.rating_count -%}
      {%- if rating > 0 and count > 0 -%}
        <div class="best-products__reviews">
          {%- comment -%} Calculate full and empty stars {%- endcomment -%}
          {%- assign full_stars = rating | floor -%}
          {%- assign decimal_part = rating | modulo: 1 -%}
          {%- assign has_half_star = false -%}
          {%- if decimal_part >= 0.25 and decimal_part < 0.75 -%}
            {%- assign has_half_star = true -%}
          {%- elsif decimal_part >= 0.75 -%}
            {%- assign full_stars = full_stars | plus: 1 -%}
          {%- endif -%}
          {%- assign half_star_position = full_stars | plus: 1 -%}

          <div class="best-products__stars" aria-hidden="true">
            {%- for i in (1..5) -%}
              {%- if i <= full_stars -%}
                {%- comment -%} Full star {%- endcomment -%}
                <span class="best-products__star best-products__star--full">
                  <svg width="16" height="16" viewBox="0 0 18 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 0L11.0206 6.21885H17.5595L12.2694 10.0623L14.2901 16.2812L9 12.4377L3.70993 16.2812L5.73056 10.0623L0.440492 6.21885H6.97937L9 0Z" fill="currentColor"/>
                  </svg>
                </span>
              {%- elsif i == half_star_position and has_half_star -%}
                {%- comment -%} Half star {%- endcomment -%}
                <span class="best-products__star best-products__star--half">
                  <svg width="16" height="16" viewBox="0 0 18 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                      <linearGradient id="half-{{ section.id }}-{{ product.id }}">
                        <stop offset="50%" stop-color="currentColor"/>
                        <stop offset="50%" stop-color="transparent"/>
                      </linearGradient>
                    </defs>
                    <path d="M9 0L11.0206 6.21885H17.5595L12.2694 10.0623L14.2901 16.2812L9 12.4377L3.70993 16.2812L5.73056 10.0623L0.440492 6.21885H6.97937L9 0Z" fill="url(#half-{{ section.id }}-{{ product.id }})" stroke="currentColor" stroke-width="0.5"/>
                  </svg>
                </span>
              {%- else -%}
                {%- comment -%} Empty star {%- endcomment -%}
                <span class="best-products__star best-products__star--empty">
                  <svg width="16" height="16" viewBox="0 0 18 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 0L11.0206 6.21885H17.5595L12.2694 10.0623L14.2901 16.2812L9 12.4377L3.70993 16.2812L5.73056 10.0623L0.440492 6.21885H6.97937L9 0Z" fill="none" stroke="currentColor" stroke-width="1"/>
                  </svg>
                </span>
              {%- endif -%}
            {%- endfor -%}
          </div>

          <span class="best-products__rating-text">
            ({{ count }} {% if count == 1 %}review{% else %}reviews{% endif %})
          </span>
        </div>
      {%- endif -%}

      {%- comment -%} Product Title {%- endcomment -%}
      <h3 class="best-products__product-title">
        <a href="{{ product.url }}">{{ product.title | escape }}</a>
      </h3>

      {%- comment -%} Price {%- endcomment -%}
      <p class="best-products__price">
        {{ price_prefix }}{{ display_price }}
      </p>

      {%- comment -%} Description (2-3 lines, truncated) {%- endcomment -%}
      {%- if product.description != blank -%}
        <p class="best-products__description">
          {{ product.description | strip_html | truncatewords: 20 }}
        </p>
      {%- endif -%}

      {%- comment -%} Add to Cart Button with Icon {%- endcomment -%}
      <quick-view-product class="best-products__quick-view">
        <button
          class="best-products__add-to-cart"
          data-href="{{ product.url }}"
          aria-label="Quick view {{ product.title | escape }}"
        >
          <span>Add to cart - {{ display_price }}</span>
          <span class="icon" aria-hidden="true" role="img">
            {%- render 'theme-symbols', icon: 'arrow_icon_smallest' -%}
          </span>
        </button>
      </quick-view-product>

    </div>

  </div>
</div>
